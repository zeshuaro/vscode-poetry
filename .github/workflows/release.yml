name: Release

on:
  workflow_dispatch:
    inputs:
      release-type:
        description: Release type
        required: true
        default: patch
        type: choice
        options:
          - major
          - minor
          - patch

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    if: ${{ github.ref == 'refs/heads/main' }}

    steps:
      - name: Checkout 🛎️
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT }}

      - name: Setup Node 💻
        uses: actions/setup-node@v3
        with:
          node-version-file: .nvmrc
          cache: yarn

      - name: Get previous tag 🏷️
        id: previous-tag
        uses: WyriHaximus/github-action-get-previous-tag@v1.2.2

      - name: Bump extension version 🔼
        id: bump-version
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          yarn
          yarn config set version-git-message "chore(release): v%s [skip ci]"
          yarn version --${{ github.event.inputs.release-type }}
          git push --force --follow-tags

      - name: Get latest tag 🏷️
        id: latest-tag
        uses: WyriHaximus/github-action-get-previous-tag@v1.2.2

      - name: Generate changelog 📝
        id: generate-changelog
        uses: mikepenz/release-changelog-builder-action@v3.4.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          configuration: changelog-config.json
          fromTag: ${{ steps.previous-tag.outputs.tag }}
          toTag: ${{ steps.latest-tag.outputs.tag }}

      - name: Update changelog 🆕
        env:
          version: ${{ steps.latest-tag.outputs.tag }}
        run: |
          # Delete tag on version commit
          git tag -d ${{ env.version }}
          git push --delete origin ${{ env.version }}

          # Update changelog file
          printf "# ${{ env.version }}\n\n${{ steps.generate-changelog.outputs.changelog }}" | cat - CHANGELOG.md > /tmp/changelog && mv /tmp/changelog CHANGELOG.md
          git add CHANGELOG.md
          git commit -am "docs(changelog): ${{ env.version }} [skip ci]"

          # Re-tag commit
          git tag ${{ env.version }}
          git push --force --follow-tags

      - name: Publish 📡
        run: |
          yarn package
          yarn vsce publish --yarn -p ${{ secrets.VSCE_PAT }}

      - name: Release 🚀
        uses: ncipollo/release-action@v1.11.1
        with:
          tag: ${{ steps.latest-tag.outputs.tag }}
          artifacts: "vscode-python-poetry-*.vsix"
          body: ${{ steps.generate-changelog.outputs.changelog }}
          token: ${{ secrets.PAT }}
